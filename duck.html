<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>打鴨子學金融：儲值卡 vs 信用卡</title>
  <style>
    html, body { margin:0; height:100%; background:#0b0f1a; color:#fff; font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif; }
    #wrap { display:flex; flex-direction:column; height:100%; }
    #topbar {
      padding: 10px 12px;
      background: rgba(0,0,0,.45);
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .pill { border:1px solid rgba(255,255,255,.25); border-radius:999px; padding:2px 10px; font-size:12px; opacity:.95; }
    #question { font-weight:700; }
    #sub { opacity:.9; font-size:13px; margin-top:4px; }
    #panel { padding:10px 12px; background: rgba(0,0,0,.35); border-top: 1px solid rgba(255,255,255,.08); }
    button {
      appearance:none; border:1px solid rgba(255,255,255,.25); background: rgba(255,255,255,.06);
      color:#fff; padding:10px 12px; border-radius:12px; font-weight:700;
    }
    button:active { transform: scale(.99); }
    #canvas { width:100%; flex:1; display:block; touch-action: manipulation; }
    .hint { opacity:.9; font-size:13px; line-height:1.35; }
    .warn { color:#ffd66b; }
  </style>
</head>
<body>
<div id="wrap">
  <div id="topbar">
    <div class="pill">分數：<span id="score">0</span></div>
    <div class="pill">生命：<span id="hp">3</span></div>
    <div class="pill">連對：<span id="streak">0</span></div>
    <div class="pill">倒數：<span id="time">10</span>s</div>
    <div style="flex:1; min-width:200px;">
      <div id="question">按「開始」出題</div>
      <div id="sub" class="hint">玩法：看題目 → 點擊/點觸正確鴨子。打錯會扣生命。</div>
    </div>
    <button id="btnStart">開始</button>
    <button id="btnRestart" style="display:none;">重來</button>
  </div>

  <canvas id="canvas"></canvas>

  <div id="panel">
    <div class="hint">
      <span class="warn">教學核心：</span>
      儲值卡＝先儲值（預付）→再消費（扣餘額）；
      信用卡＝先消費→銀行先墊款→你之後繳款（延後給付）。
    </div>
  </div>
</div>

<script>
(() => {
  // ===== Canvas setup =====
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha: false });

  function resize() {
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // draw in CSS pixels
  }
  window.addEventListener('resize', resize);
  resize();

  // ===== UI =====
  const elScore = document.getElementById('score');
  const elHp = document.getElementById('hp');
  const elStreak = document.getElementById('streak');
  const elTime = document.getElementById('time');
  const elQ = document.getElementById('question');
  const elSub = document.getElementById('sub');
  const btnStart = document.getElementById('btnStart');
  const btnRestart = document.getElementById('btnRestart');

  // ===== Question bank (可擴充) =====
  // 每題：prompt + options (2~4)；正確答案 index
  const QUESTIONS = [
    {
      prompt: "哪個是「儲值卡」的正確流程？",
      options: ["先儲值 → 再消費", "先消費 → 後繳款", "先消費 → 再儲值"],
      correct: 0,
      explain: "儲值卡是預付：先把錢存進去，消費時扣餘額。"
    },
    {
      prompt: "哪個是「信用卡」的正確流程？",
      options: ["先儲值 → 再消費", "先消費 → 後繳款", "先繳款 → 再消費"],
      correct: 1,
      explain: "信用卡是延後給付：先消費，之後收到帳單再付錢。"
    },
    {
      prompt: "你刷信用卡買東西時，誰先把錢付給商店？",
      options: ["你本人當下付", "銀行/發卡機構先墊款", "商店自己吸收"],
      correct: 1,
      explain: "信用卡交易中，銀行/發卡機構會先付給商店（你之後再繳款）。"
    },
    {
      prompt: "你用儲值卡付費時，扣的是哪裡的錢？",
      options: ["卡內餘額", "銀行先墊的款", "月底帳單"],
      correct: 0,
      explain: "儲值卡消費會直接扣卡內餘額。"
    },
    {
      prompt: "看到『月底帳單』這個關鍵字，最可能是哪一種？",
      options: ["儲值卡", "信用卡", "兩者都一定有帳單"],
      correct: 1,
      explain: "月底帳單＝信用卡典型特徵（延後給付）。"
    }
  ];

  // ===== Game state =====
  let running = false;
  let score = 0, hp = 3, streak = 0;
  let timeLeft = 10;
  let timerId = null;

  let currentQ = null;
  let ducks = []; // {x,y,w,h,vx,vy,label,isCorrect,hit}

  function setHud() {
    elScore.textContent = String(score);
    elHp.textContent = String(hp);
    elStreak.textContent = String(streak);
    elTime.textContent = String(timeLeft);
  }

  function pickQuestion() {
    // random question
    currentQ = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];
    elQ.textContent = currentQ.prompt;
    elSub.textContent = "提示：點到正確鴨子得分；打錯扣生命。";
  }

  function spawnDucks() {
    ducks = [];
    const W = canvas.getBoundingClientRect().width;
    const H = canvas.getBoundingClientRect().height;

    const opts = currentQ.options.map((text, i) => ({
      text, isCorrect: i === currentQ.correct
    }));

    // 2~4 隻同時出現：用全部 options
    const count = opts.length;

    for (let i = 0; i < count; i++) {
      const w = 180, h = 70;
      const x = -w - Math.random() * 120;              // 從左外面飛入
      const y = 80 + i * (Math.min(110, (H-160)/(count))) + (Math.random()*20-10);
      const speed = 80 + Math.random()*60;             // px/s
      ducks.push({
        x, y, w, h,
        vx: speed,
        vy: (Math.random()*20 - 10),
        label: opts[i].text,
        isCorrect: opts[i].isCorrect,
        hit: false
      });
    }
  }

  function startRound() {
    timeLeft = 10;
    pickQuestion();
    spawnDucks();
    setHud();

    clearInterval(timerId);
    timerId = setInterval(() => {
      if (!running) return;
      timeLeft -= 1;
      if (timeLeft <= 0) {
        timeLeft = 0;
        setHud();
        // 沒打到正確也算失敗
        onMissed();
      } else {
        setHud();
      }
    }, 1000);
  }

  function onCorrect() {
    score += 10 + Math.min(10, streak * 2);
    streak += 1;
    elSub.textContent = "✅ 正確！" + currentQ.explain;
    startRound();
  }

  function onWrong(msg) {
    hp -= 1;
    streak = 0;
    elSub.textContent = "❌ 錯誤！" + (msg || currentQ.explain);
    if (hp <= 0) {
      endGame();
    } else {
      startRound();
    }
  }

  function onMissed() {
    hp -= 1;
    streak = 0;
    elSub.textContent = "⌛ 超時！" + currentQ.explain;
    if (hp <= 0) endGame();
    else startRound();
  }

  function endGame() {
    running = false;
    clearInterval(timerId);
    elSub.textContent = `遊戲結束。你的分數：${score}。按「重來」再玩一次。`;
    btnStart.style.display = "none";
    btnRestart.style.display = "inline-block";
  }

  // ===== Render loop =====
  let lastT = performance.now();
  function loop(t) {
    const dt = Math.min(0.05, (t - lastT) / 1000);
    lastT = t;

    const W = canvas.getBoundingClientRect().width;
    const H = canvas.getBoundingClientRect().height;

    // background
    ctx.fillStyle
