<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>2D æ‰“é³¥ç´ é¤Šï¼šå„²å€¼å¡ vs ä¿¡ç”¨å¡ï¼ˆV2ï¼‰</title>
  <style>
    :root{
      --bg:#061018;
      --panel: rgba(0,0,0,.55);
      --panel2: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.14);
      --txt:#eaf2ff;
      --muted:#b7c3da;
      --good:#4bf08a;
      --bad:#ff6b6b;
      --warn:#ffd36a;
      --accent:#7bd6ff;
      --accent2:#b39cff;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,"Noto Sans TC","Segoe UI",Roboto,Arial;}
    #wrap{height:100%;display:grid;grid-template-rows:auto 1fr auto;}
    header{
      padding:10px 14px;
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }
    header .title{font-weight:900}
    header .title span{color:var(--accent)}
    header .pill{
      padding:4px 10px;border-radius:999px;
      border:1px solid var(--line); background:var(--panel2);
      font-size:12px;color:var(--muted); white-space:nowrap;
    }
    header .spacer{flex:1}
    label.ctrl{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    input[type="range"]{width:170px}
    select,button{
      background:var(--panel2);
      border:1px solid var(--line);
      color:var(--txt);
      padding:7px 10px;
      border-radius:10px;
      font-weight:800;
      cursor:pointer;
    }
    button.primary{border-color:rgba(255,211,106,.6); box-shadow:0 0 0 2px rgba(255,211,106,.12) inset}
    button:active{transform:translateY(1px)}

    main#game{
      position:relative; overflow:hidden;
      cursor:crosshair;
      background:
        radial-gradient(900px 500px at 22% 20%, rgba(123,214,255,.14), transparent 58%),
        radial-gradient(900px 600px at 78% 18%, rgba(179,156,255,.12), transparent 60%),
        radial-gradient(900px 700px at 50% 90%, rgba(255,211,106,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.0));
      user-select:none;
    }

    /* å·¦ä¸Šæç¤º */
    #hudHint{
      position:absolute; left:12px; top:12px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      max-width:min(560px, calc(100% - 24px));
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
    }
    #hudHint .q{font-size:14px; font-weight:900; line-height:1.35}
    #hudHint .meta{margin-top:6px; display:flex; gap:8px; flex-wrap:wrap}
    .tag{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background:var(--panel2);
      padding:3px 8px;border-radius:999px;
    }

    /* ä¸­å¤®é¡Œç›®å¡ */
    #centerCard{
      position:absolute; inset:0;
      display:none; align-items:center; justify-content:center;
      pointer-events:none;
    }
    #centerCard .card{
      width:min(860px, calc(100% - 28px));
      background:rgba(0,0,0,.68);
      border:1px solid rgba(255,255,255,.18);
      border-radius:20px;
      padding:16px 18px 14px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    #centerCard .head{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    #centerCard .head .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.16);
      color:var(--muted);font-size:12px;font-weight:800;
    }
    #centerCard .title{
      font-size:20px;font-weight:950;line-height:1.35;
    }
    #centerCard .sub{
      margin-top:10px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      color:var(--muted);font-size:12px;
    }
    .bar{
      height:10px; flex:1; min-width:220px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%; width:0%;
      background:linear-gradient(90deg, rgba(123,214,255,.95), rgba(179,156,255,.95));
    }

    /* é³¥ï¼ˆé¸é …ï¼‰â€” V2 æ”¾å¤§ã€å­—æ”¾å¤§ */
    .bird{
      position:absolute;
      left:0; top:0;
      transform:translate(-9999px,-9999px);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.20);
      background:rgba(0,0,0,.38);
      box-shadow:0 12px 34px rgba(0,0,0,.28);
      display:flex;align-items:center;gap:12px;
      padding:10px 12px;
      backdrop-filter: blur(4px);
    }
    .bird:hover{border-color:rgba(255,211,106,.55)}
    .icon{
      width:52px;height:52px;border-radius:16px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .labelWrap{min-width:0}
    .label{
      font-weight:950; font-size:18px; line-height:1.05;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      letter-spacing:.2px;
    }
    .chips{margin-top:6px; display:flex; gap:7px; flex-wrap:wrap}
    .chip{
      font-size:12px; padding:3px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }

    /* å›é¥‹è¨Šæ¯ */
    #toast{
      position:absolute; left:50%; bottom:14px;
      transform:translateX(-50%);
      width:min(920px, calc(100% - 24px));
      background:rgba(0,0,0,.66);
      border:1px solid rgba(255,255,255,.16);
      border-radius:16px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      display:none;
      font-size:14px;
      line-height:1.35;
    }
    #toast b{font-weight:950}
    #toast .ok{color:var(--good)}
    #toast .no{color:var(--bad)}

    /* å°„æ“Šç‰¹æ•ˆï¼šæº–æ˜Ÿæ³¢ç´‹ + é–ƒå…‰ */
    .shot{
      position:absolute;
      width:18px;height:18px;border-radius:999px;
      transform:translate(-50%,-50%);
      pointer-events:none;
      border:2px solid rgba(255,255,255,.85);
      box-shadow:0 0 0 6px rgba(123,214,255,.18), 0 0 28px rgba(123,214,255,.22);
      animation: shotPop .28s ease-out forwards;
    }
    .flash{
      position:absolute;
      width:120px;height:120px;border-radius:999px;
      transform:translate(-50%,-50%);
      pointer-events:none;
      background:radial-gradient(circle, rgba(255,211,106,.35), transparent 60%);
      animation: flash .22s ease-out forwards;
      mix-blend-mode:screen;
    }
    @keyframes shotPop{
      from{opacity:1; transform:translate(-50%,-50%) scale(.85)}
      to{opacity:0; transform:translate(-50%,-50%) scale(1.8)}
    }
    @keyframes flash{
      from{opacity:.9; transform:translate(-50%,-50%) scale(.5)}
      to{opacity:0; transform:translate(-50%,-50%) scale(1.25)}
    }
    .spark{
      position:absolute;
      width:6px;height:6px;border-radius:2px;
      transform:translate(-50%,-50%);
      pointer-events:none;
      background:rgba(255,255,255,.85);
      box-shadow:0 0 18px rgba(255,211,106,.35);
      animation: spark .36s ease-out forwards;
    }
    @keyframes spark{
      from{opacity:1; transform:translate(-50%,-50%) translate(0,0) rotate(0deg)}
      to{opacity:0; transform:translate(-50%,-50%) translate(var(--dx), var(--dy)) rotate(120deg)}
    }

    #footer{
      padding:10px 14px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      display:flex;gap:10px;flex-wrap:wrap;
      background:linear-gradient(0deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }
    #footer .hint{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    kbd{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas;
      font-size:11px;
      padding:2px 6px;border-radius:6px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--txt);
    }
  </style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="title">2D æ‰“é³¥ç´ é¤Šï¼š<span>æ”¯ä»˜æ–¹å¼åˆ¤è®€</span></div>
    <div class="pill" id="pScore">åˆ†æ•¸ï¼š0</div>
    <div class="pill" id="pStreak">é€£å°ï¼š0</div>
    <div class="pill" id="pQ">é¡Œè™Ÿï¼š0/0</div>

    <div class="spacer"></div>

    <label class="ctrl">é€Ÿåº¦
      <input id="speed" type="range" min="0.55" max="1.85" step="0.05" value="0.95" />
    </label>

    <label class="ctrl">ç›®æ¨™å¤§å°
      <input id="size" type="range" min="0.90" max="1.35" step="0.05" value="1.15" />
    </label>

    <label class="ctrl">é›£åº¦
      <select id="difficulty">
        <option value="easy">ç°¡å–®</option>
        <option value="normal" selected>ä¸€èˆ¬</option>
        <option value="hard">å›°é›£</option>
      </select>
    </label>

    <button class="primary" id="btnStart">é–‹å§‹ / ä¸‹ä¸€é¡Œ</button>
    <button id="btnReset">é‡ä¾†</button>
  </header>

  <main id="game" aria-label="game area">
    <div id="hudHint">
      <div class="q">è¦å‰‡ï¼šå…ˆçœ‹é¡Œç›® 5 ç§’ â†’ å†æ‰“ä¸­ã€Œæ­£ç¢ºé‚£éš»é³¥ã€</div>
      <div class="meta">
        <span class="tag">æŠ“é—œéµï¼šå…ˆä»˜ / å¾Œä»˜</span>
        <span class="tag">æŠ“é—œéµï¼šèƒ½ä¸èƒ½è¶…æ”¯</span>
        <span class="tag">æŠ“é—œéµï¼šæœˆåº•å¸³å–® or ç«‹åˆ»æ‰£</span>
      </div>
    </div>

    <div id="centerCard">
      <div class="card">
        <div class="head">
          <span class="badge">ğŸ“Œ å…ˆè®€é¡Œï¼ˆ5 ç§’ï¼‰</span>
          <span class="badge" id="ccFocus">ç„¦é»ï¼šâ€”</span>
          <span class="badge" id="ccKey">é—œéµï¼šâ€”</span>
        </div>
        <div class="title" id="ccText">â€”</div>
        <div class="sub">
          <span id="ccCountdown">æº–å‚™é–‹å§‹ï¼š5</span>
          <span class="bar" aria-hidden="true"><i id="ccBar"></i></span>
          <span style="min-width:92px;text-align:right">å‡ºé³¥å€’æ•¸</span>
        </div>
      </div>
    </div>

    <div id="toast"></div>
  </main>

  <div id="footer">
    <div class="hint">
      æ“ä½œï¼š<kbd>æ»‘é¼ é»æ“Š</kbd> æ‰“é³¥ï½œ
      çœ‹åˆ°èˆŠç•«é¢ï¼šç¶²å€åŠ  <kbd>?v=2</kbd> æˆ– <kbd>Ctrl+F5</kbd>
    </div>
  </div>
</div>

<script>
(() => {
  // ====== é¡Œåº«ï¼ˆäººè©±ç‰ˆï¼šçŸ­ã€æ¸…æ¥šã€ç´ é¤Šï¼‰======
  // æ¯é¡Œéƒ½åœ¨å•ï¼šå…ˆä»˜/å¾Œä»˜ã€èƒ½å¦è¶…æ”¯ã€æœˆçµ/å³æ‰£
  const BANK = [
    {
      text: "ä½ ç¾åœ¨æ²’éŒ¢ï¼Œä½†åº—å®¶èªªï¼šå…ˆæŠŠæ±è¥¿æ‹¿èµ°ï¼Œæœˆåº•å†ä¸€èµ·ç¹³ã€‚ä½ ç”¨çš„æ˜¯å“ªä¸€ç¨®ï¼Ÿ",
      focus: "ä»˜æ¬¾æ™‚é–“",
      key: "å…ˆç”¨å¾Œä»˜ï¼å¾Œä»˜",
      answer: "credit",
      options: [
        { id:"credit", label:"ä¿¡ç”¨å¡", chips:["å…ˆç”¨å¾Œä»˜","æœˆåº•å¸³å–®"], why:"ä½ å…ˆæ¶ˆè²»ï¼Œä¹‹å¾Œï¼ˆæœˆåº•ï¼‰æ‰ç¹³æ¬¾ã€‚"},
        { id:"prepaid", label:"å„²å€¼å¡", chips:["å…ˆåŠ å€¼","æ‰£é¤˜é¡"], why:"å„²å€¼å¡ä¸€å®šè¦å…ˆæœ‰é¤˜é¡æ‰æ‰£ã€‚"},
        { id:"debit", label:"ç°½å¸³/é‡‘èå¡", chips:["ç«‹åˆ»æ‰£æ¬¾","æ‰£å­˜æ¬¾"], why:"ç°½å¸³å¡æ˜¯ç•¶ä¸‹å¾éŠ€è¡Œå­˜æ¬¾æ‰£ï¼Œä¸ç­‰æœˆåº•ã€‚"},
        { id:"cash", label:"ç¾é‡‘", chips:["ç•¶ä¸‹ä»˜æ¸…","ä¸æ¬ æ¬¾"], why:"ç¾é‡‘æ˜¯ç«‹åˆ»ä»˜æ¸…ï¼Œæ²’æœ‰æœˆåº•å¸³å–®ã€‚"}
      ]
    },
    {
      text: "ä½ åˆ·å¡å¾Œï¼ŒéŒ¢ç«‹åˆ»å¾éŠ€è¡Œå¸³æˆ¶æ‰£æ‰ï¼ˆä¸æ˜¯æœˆåº•å¸³å–®ï¼‰ã€‚é€™æ˜¯å“ªä¸€ç¨®ï¼Ÿ",
      focus: "æ‰£æ¬¾æ–¹å¼",
      key: "ç«‹åˆ»æ‰£å¸³æˆ¶ï¼å³æ‰£",
      answer: "debit",
      options: [
        { id:"debit", label:"ç°½å¸³/é‡‘èå¡", chips:["å³æ‰£","æ‰£å­˜æ¬¾"], why:"é‡é»æ˜¯ã€Œç›´æ¥æ‰£éŠ€è¡Œå¸³æˆ¶ã€ã€‚"},
        { id:"credit", label:"ä¿¡ç”¨å¡", chips:["å¾Œä»˜","æœˆåº•å¸³å–®"], why:"ä¿¡ç”¨å¡é€šå¸¸æ˜¯æœˆåº•çµå¸³å†ç¹³ã€‚"},
        { id:"prepaid", label:"å„²å€¼å¡", chips:["æ‰£é¤˜é¡","å…ˆåŠ å€¼"], why:"å„²å€¼å¡æ‰£çš„æ˜¯å¡å…§é¤˜é¡ï¼Œä¸ä¸€å®šé€£åˆ°å¸³æˆ¶ã€‚"},
        { id:"bnpl", label:"å…ˆè²·å¾Œä»˜(BNPL)", chips:["åˆ†æœŸ","å¹³å°é¡åº¦"], why:"BNPLå¤šæ˜¯å¹³å°åˆ†æœŸï¼Œä¸æ˜¯éŠ€è¡Œå³æ‰£ã€‚"}
      ]
    },
    {
      text: "ä½ ç”¨äº¤é€šå¡æ­è»Šï¼šè¦å…ˆåŠ å€¼ï¼Œé¤˜é¡ä¸å¤ å°±åˆ·ä¸éã€‚é€™æ˜¯å“ªä¸€ç¨®ï¼Ÿ",
      focus: "èƒ½å¦å…ˆç”¨å¾Œä»˜",
      key: "é¤˜é¡ä¸å¤ å°±ä¸èƒ½ç”¨ï¼å…ˆä»˜",
      answer: "prepaid",
      options: [
        { id:"prepaid", label:"å„²å€¼å¡", chips:["å…ˆåŠ å€¼","ä¸è¶³å°±ä¸è¡Œ"], why:"ä½ åªèƒ½èŠ±å¡å…§é¤˜é¡ã€‚"},
        { id:"credit", label:"ä¿¡ç”¨å¡", chips:["ç”¨é¡åº¦","ä¹‹å¾Œå†ç¹³"], why:"ä¿¡ç”¨å¡ä¸æ˜¯çœ‹å¡å…§é¤˜é¡ã€‚"},
        { id:"debit", label:"ç°½å¸³/é‡‘èå¡", chips:["æ‰£å­˜æ¬¾","å³æ‰£"], why:"ç°½å¸³å¡æ˜¯çœ‹å¸³æˆ¶é¤˜é¡ï¼Œä¸æ˜¯åŠ å€¼é¤˜é¡ã€‚"},
        { id:"cash", label:"ç¾é‡‘", chips:["ç•¶ä¸‹ä»˜","æ‰¾é›¶"], why:"æƒ…å¢ƒé‡é»æ˜¯ã€ŒåŠ å€¼é¤˜é¡ã€ã€‚"}
      ]
    },
    {
      text: "ä½ åˆ·å¡è²·æ±è¥¿å¾Œæ‹–è‘—ä¸ç¹³ï¼Œçµæœå¸³å–®åˆ©æ¯è¶Šæ»¾è¶Šå¤šã€‚æœ€åƒå“ªä¸€ç¨®ï¼Ÿ",
      focus: "è²»ç”¨/é¢¨éšª",
      key: "æœªç¹³æ¸…ï¼‹åˆ©æ¯ï¼ä¿¡ç”¨",
      answer: "credit",
      options: [
        { id:"credit", label:"ä¿¡ç”¨å¡", chips:["å¯èƒ½åˆ©æ¯","å¾ªç’°"], why:"æ²’å…¨é¡ç¹³æ¸…å¯èƒ½ç”¢ç”Ÿåˆ©æ¯/å¾ªç’°ã€‚"},
        { id:"prepaid", label:"å„²å€¼å¡", chips:["å…ˆä»˜","ä¸è¶…æ”¯"], why:"å„²å€¼å¡ä¸èƒ½é€æ”¯ï¼Œä¸æœƒæœ‰å¾ªç’°åˆ©æ¯ã€‚"},
        { id:"debit", label:"ç°½å¸³/é‡‘èå¡", chips:["å³æ‰£","æ‰£å­˜æ¬¾"], why:"å³æ‰£ä¸æœƒå‡ºç¾ã€Œæ‹–å¸³å–®åˆ©æ¯ã€ã€‚"},
        { id:"mobile", label:"è¡Œå‹•éŒ¢åŒ…(é¤˜é¡)", chips:["æ‰£é¤˜é¡","å…ˆä»˜"], why:"å¤šåŠæ˜¯å…ˆä»˜/æ‰£é¤˜é¡ã€‚"}
      ]
    },
    {
      text: "å®¶é•·èªªï¼šä½ åªèƒ½èŠ±ã€å…ˆå­˜é€²å»ã€çš„éŒ¢ï¼Œä¸èƒ½å€ŸéŒ¢è¶…æ”¯ã€‚æœ€åƒå“ªä¸€ç¨®ï¼Ÿ",
      focus: "èƒ½å¦è¶…æ”¯",
      key: "ä¸èƒ½è¶…æ”¯ï¼å…ˆä»˜",
      answer: "prepaid",
      options: [
        { id:"prepaid", label:"å„²å€¼å¡", chips:["å…ˆå­˜éŒ¢","ä¸èƒ½è¶…æ”¯"], why:"é¤˜é¡å°±æ˜¯ä¸Šé™ã€‚"},
        { id:"credit", label:"ä¿¡ç”¨å¡", chips:["æœ‰é¡åº¦","å…ˆç”¨å¾Œç¹³"], why:"ä¿¡ç”¨å¡æ˜¯å…ˆç”¨é¡åº¦å†ç¹³ã€‚"},
        { id:"bnpl", label:"å…ˆè²·å¾Œä»˜(BNPL)", chips:["å»¶å¾Œä»˜","åƒå°é¡ä¿¡ç”¨"], why:"BNPLä¹Ÿæ˜¯å…ˆç”¨å¾Œä»˜ã€‚"},
        { id:"cash", label:"ç¾é‡‘", chips:["ç•¶ä¸‹ä»˜","ä¸æ¬ æ¬¾"], why:"ç¾é‡‘ä¹Ÿä¸æ¬ æ¬¾ï¼Œä½†é¡Œå¹¹ç‰¹åˆ¥å¼·èª¿ã€Œå…ˆå­˜é€²å»ã€æ›´åƒå„²å€¼ã€‚"}
      ]
    },
    {
      text: "ä½ ç”¨æ‰‹æ©Ÿä»˜æ¬¾ï¼šæœ‰æ™‚æ˜¯ç¶ä¿¡ç”¨å¡ï¼ˆæœˆåº•ç¹³ï¼‰ï¼Œæœ‰æ™‚æ˜¯ç”¨éŒ¢åŒ…é¤˜é¡ï¼ˆå…ˆå„²å€¼ï¼‰ã€‚è¦æ€éº¼åˆ¤æ–·ï¼Ÿ",
      focus: "åˆ¤è®€æ–¹æ³•",
      key: "çœ‹èƒŒå¾Œè³‡é‡‘ä¾†æº",
      answer: "mixed",
      options: [
        { id:"mixed", label:"çœ‹å®ƒç¶å“ªå€‹ä¾†æº", chips:["å¯èƒ½ä¿¡ç”¨","å¯èƒ½å„²å€¼"], why:"è¡Œå‹•æ”¯ä»˜åªæ˜¯å·¥å…·ï¼Œé—œéµåœ¨èƒŒå¾Œæ˜¯ä¿¡ç”¨å¡/é¤˜é¡/å¸³æˆ¶ã€‚"},
        { id:"credit", label:"ä¸€å¾‹ç®—ä¿¡ç”¨å¡", chips:["éƒ½å¾Œä»˜"], why:"éŒ¯ï¼šä¹Ÿå¯èƒ½æ‰£é¤˜é¡æˆ–æ‰£å¸³æˆ¶ã€‚"},
        { id:"prepaid", label:"ä¸€å¾‹ç®—å„²å€¼å¡", chips:["éƒ½å…ˆä»˜"], why:"éŒ¯ï¼šä¹Ÿå¯èƒ½ç¶ä¿¡ç”¨å¡æœˆçµã€‚"},
        { id:"cash", label:"è·Ÿç¾é‡‘ä¸€æ¨£", chips:["éƒ½ç•¶ä¸‹"], why:"éŒ¯ï¼šä¾†æºä¸åŒè¦å‰‡å°±ä¸åŒã€‚"}
      ]
    }
  ];

  // ====== DOM ======
  const $ = (id) => document.getElementById(id);
  const game = $("game");
  const btnStart = $("btnStart");
  const btnReset = $("btnReset");
  const speedCtl = $("speed");
  const sizeCtl  = $("size");
  const diffCtl  = $("difficulty");
  const pScore = $("pScore");
  const pStreak = $("pStreak");
  const pQ = $("pQ");
  const toast = $("toast");

  const centerCard = $("centerCard");
  const ccText = $("ccText");
  const ccFocus = $("ccFocus");
  const ccKey = $("ccKey");
  const ccCountdown = $("ccCountdown");
  const ccBar = $("ccBar");

  // ====== éŸ³æ•ˆï¼ˆä¸ç”¨å¤–éƒ¨æª”ï¼‰======
  let audioCtx = null;
  function beep(type="shot"){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const ctx = audioCtx;

      const o = ctx.createOscillator();
      const g = ctx.createGain();

      const now = ctx.currentTime;
      o.type = "square";

      if(type==="shot"){ o.frequency.setValueAtTime(760, now); }
      if(type==="hit"){  o.frequency.setValueAtTime(980, now); }
      if(type==="miss"){ o.frequency.setValueAtTime(220, now); }

      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.10, now+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.12);

      o.connect(g); g.connect(ctx.destination);
      o.start(now);
      o.stop(now+0.14);
    }catch(e){}
  }

  // ====== ç‹€æ…‹ ======
  let score = 0, streak = 0, qIndex = -1;
  let birds = [];
  let raf = null;
  let running = false;
  let locked = false;

  const DIFF = {
    easy:   { count: 4, agility: 0.52 },
    normal: { count: 4, agility: 0.75 },
    hard:   { count: 5, agility: 0.92 }
  };

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function rnd(a,b){ return a + Math.random()*(b-a); }

  function setHUD(){
    pScore.textContent = `åˆ†æ•¸ï¼š${score}`;
    pStreak.textContent = `é€£å°ï¼š${streak}`;
    pQ.textContent = `é¡Œè™Ÿï¼š${Math.max(0,qIndex+1)}/${BANK.length}`;
  }

  function showToast(ok, msg){
    toast.style.display = "block";
    toast.innerHTML = ok
      ? `<b class="ok">âœ… æ‰“ä¸­ï¼</b>ã€€${msg}`
      : `<b class="no">âŒ æ‰“éŒ¯ï¼</b>ã€€${msg}`;
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.style.display="none", 1700);
  }

  // ====== å°„æ“Šç‰¹æ•ˆï¼ˆé»å“ªè£¡éƒ½æœ‰ï¼‰======
  function shotFX(x,y){
    const s = document.createElement("div");
    s.className = "shot";
    s.style.left = x+"px"; s.style.top = y+"px";
    game.appendChild(s);

    const f = document.createElement("div");
    f.className = "flash";
    f.style.left = x+"px"; f.style.top = y+"px";
    game.appendChild(f);

    // sparks
    for(let i=0;i<6;i++){
      const p = document.createElement("div");
      p.className = "spark";
      p.style.left = x+"px"; p.style.top = y+"px";
      p.style.setProperty("--dx", `${rnd(-60,60).toFixed(0)}px`);
      p.style.setProperty("--dy", `${rnd(-50,50).toFixed(0)}px`);
      game.appendChild(p);
      setTimeout(()=>p.remove(), 420);
    }

    setTimeout(()=>s.remove(), 320);
    setTimeout(()=>f.remove(), 260);
  }

  // é»èƒŒæ™¯ä¹Ÿæœƒæœ‰å°„æ“Šæ„Ÿï¼ˆä½†ä¸ç®—ç­”é¡Œï¼‰
  game.addEventListener("pointerdown", (e)=>{
    const rect = game.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    shotFX(x,y);
    beep("shot");
  });

  // ====== é³¥åœ–ç¤ºï¼ˆSVGï¼‰======
  function birdIconHTML(kind){
    const color = {
      credit:"#ffd36a", prepaid:"#7bd6ff", debit:"#4bf08a",
      cash:"#b39cff", bnpl:"#ff6b6b", mobile:"#7bd6ff", mixed:"#ffd36a"
    }[kind] || "#b7c3da";

    return `
      <svg width="28" height="28" viewBox="0 0 64 64" aria-hidden="true">
        <path fill="${color}" d="M41 12c-7 2-11 7-12 14-8-5-18-1-20 8-3 10 8 20 22 17 9-2 17-11 16-22-1-6-3-11-6-17z"/>
        <circle fill="rgba(0,0,0,.6)" cx="40" cy="26" r="3"/>
        <path fill="rgba(0,0,0,.35)" d="M47 30c7 2 11 5 11 8-8 2-14 0-18-4 2-3 4-4 7-4z"/>
      </svg>`;
  }

  function clearBirds(){
    for(const b of birds) b.el.remove();
    birds = [];
  }

  function makeBird(opt, answerId){
    const el = document.createElement("div");
    el.className = "bird";
    el.dataset.id = opt.id;

    const chipA = opt.chips?.[0] || "";
    const chipB = opt.chips?.[1] || "";

    el.innerHTML = `
      <div class="icon">${birdIconHTML(opt.id)}</div>
      <div class="labelWrap">
        <div class="label">${opt.label}</div>
        <div class="chips">
          ${chipA ? `<span class="chip">${chipA}</span>`:""}
          ${chipB ? `<span class="chip">${chipB}</span>`:""}
        </div>
      </div>
    `;

    game.appendChild(el);

    // V2ï¼šåŠ å¤§é»æ“Šåˆ¤å®šï¼ˆpadding + æœ€å°å°ºå¯¸ï¼‰
    const baseW = 280;
    const baseH = 78;
    const scale = parseFloat(sizeCtl.value);
    const w = baseW * scale;
    const h = baseH * scale;
    el.style.width = w + "px";
    el.style.height = h + "px";

    const rect = game.getBoundingClientRect();
    const pad = 14;
    let x = rnd(pad, rect.width - w - pad);
    let y = rnd(100, rect.height - h - 56);

    // é€Ÿåº¦ï¼ˆæ…¢ä¸€é»ä½†æ´»ï¼‰
    let vx = rnd(-1.1, 1.1);
    let vy = rnd(-0.9, 0.9);
    if(Math.abs(vx) < 0.55) vx = vx < 0 ? -0.85 : 0.85;

    const state = { el, opt, answerId, x, y, vx, vy, w, h };

    el.addEventListener("click", (e)=>{
      e.preventDefault();
      e.stopPropagation(); // ä¸è¦åŒæ™‚è¢«èƒŒæ™¯ click ç®—å…©æ¬¡
      if(locked || !running) return;

      // è®“é»åˆ°é³¥ä¹Ÿåœ¨é³¥ä¸­å¿ƒç‚¸ä¸€ä¸‹ï¼Œæ‰‹æ„Ÿæ›´çˆ½
      const r = game.getBoundingClientRect();
      const cx = (state.x + state.w/2);
      const cy = (state.y + state.h/2);
      shotFX(cx,cy);

      onShoot(state);
    });

    return state;
  }

  function onShoot(b){
    locked = true;
    const q = BANK[qIndex];
    const correct = (b.opt.id === b.answerId);

    if(correct){
      beep("hit");
      score += 12 + Math.min(8, streak*2);
      streak += 1;
      showToast(true, b.opt.why);
    }else{
      beep("miss");
      score = Math.max(0, score - 8);
      streak = 0;
      const right = q.options.find(o=> o.id===q.answer);
      showToast(false, `æ­£è§£æ˜¯ <b>${right.label}</b>ï¼š${right.why}`);
    }
    setHUD();

    setTimeout(()=>{
      locked = false;
      nextQuestion();
    }, 900);
  }

  function stopLoop(){
    running = false;
    if(raf) cancelAnimationFrame(raf);
    raf = null;
  }

  function loop(){
    if(!running) return;

    const rect = game.getBoundingClientRect();
    const pad = 12;
    const speed = parseFloat(speedCtl.value);
    const diff = DIFF[diffCtl.value];

    for(const b of birds){
      // å¾®éš¨æ©Ÿè½‰å‘ï¼Œé¿å…å¡è§’è½
      const jitter = diff.agility * 0.07;
      b.vx += rnd(-jitter, jitter);
      b.vy += rnd(-jitter, jitter);

      const maxV = 1.35 * speed * (0.85 + diff.agility*0.55);
      b.vx = clamp(b.vx, -maxV, maxV);
      b.vy = clamp(b.vy, -maxV, maxV);

      b.x += b.vx * 2.1 * speed;
      b.y += b.vy * 1.9 * speed;

      // å½ˆç‰†
      if(b.x <= pad){ b.x = pad; b.vx = Math.abs(b.vx) + 0.32; }
      if(b.x + b.w >= rect.width - pad){ b.x = rect.width - pad - b.w; b.vx = -Math.abs(b.vx) - 0.32; }
      if(b.y <= 80){ b.y = 80; b.vy = Math.abs(b.vy) + 0.25; }
      if(b.y + b.h >= rect.height - 44){ b.y = rect.height - 44 - b.h; b.vy = -Math.abs(b.vy) - 0.25; }

      b.el.style.transform = `translate(${b.x}px, ${b.y}px)`;
    }

    raf = requestAnimationFrame(loop);
  }

  async function showCenterQuestion(q){
    centerCard.style.display = "flex";
    ccText.textContent = q.text;
    ccFocus.textContent = `ç„¦é»ï¼š${q.focus}`;
    ccKey.textContent = `é—œéµï¼š${q.key}`;

    let t = 5;
    ccCountdown.textContent = `æº–å‚™é–‹å§‹ï¼š${t}`;
    ccBar.style.width = "0%";

    for(let i=0;i<50;i++){
      const pct = (i+1)/50;
      ccBar.style.width = (pct*100).toFixed(0) + "%";
      const nowT = Math.ceil(5 - pct*5);
      if(nowT !== t){
        t = nowT;
        ccCountdown.textContent = `æº–å‚™é–‹å§‹ï¼š${t}`;
      }
      await new Promise(r=>setTimeout(r, 100));
    }

    centerCard.style.display = "none";
  }

  function spawnForQuestion(q){
    clearBirds();

    const diff = DIFF[diffCtl.value];
    let list = q.options.slice();

    if(diff.count === 5){
      const wrongs = list.filter(o=> o.id !== q.answer);
      const pick = wrongs[Math.floor(Math.random()*wrongs.length)];
      list.push({
        id: pick.id,
        label: pick.label + "ï¼ˆæ··ï¼‰",
        chips: ["çœ‹é—œéµå­—","åˆ¥è¢«é¨™"],
        why: pick.why
      });
    }

    list.sort(()=>Math.random()-0.5);

    birds = list.map(opt => makeBird(opt, q.answer));

    running = true;
    if(!raf) raf = requestAnimationFrame(loop);
  }

  async function nextQuestion(){
    stopLoop();
    clearBirds();

    qIndex += 1;
    if(qIndex >= BANK.length){
      centerCard.style.display = "flex";
      ccText.textContent = "å®Œæˆï¼æŒ‰ã€Œé–‹å§‹ / ä¸‹ä¸€é¡Œã€å¯å†è·‘ä¸€æ¬¡é¡Œåº«ã€‚";
      ccFocus.textContent = "ç„¦é»ï¼šç¸½çµ";
      ccKey.textContent = "å…ˆä»˜/å¾Œä»˜ï½œèƒ½å¦è¶…æ”¯ï½œæœˆåº•å¸³å–®/å³æ‰£";
      ccCountdown.textContent = "â€”";
      ccBar.style.width = "100%";
      return;
    }

    setHUD();
    const q = BANK[qIndex];
    await showCenterQuestion(q);
    spawnForQuestion(q);
  }

  function resetAll(){
    stopLoop();
    clearBirds();
    score = 0; streak = 0; qIndex = -1;
    locked = false;
    setHUD();
    toast.style.display = "none";

    centerCard.style.display = "flex";
    ccText.textContent = "æŒ‰ã€Œé–‹å§‹ / ä¸‹ä¸€é¡Œã€é–‹å§‹ã€‚æ¯é¡Œå…ˆè®€ 5 ç§’ï¼Œå†æ‰“ä¸­æ­£ç¢ºé‚£éš»é³¥ã€‚";
    ccFocus.textContent = "ç„¦é»ï¼šå…ˆä»˜ / å¾Œä»˜";
    ccKey.textContent = "é—œéµï¼šèƒ½å¦è¶…æ”¯ / æœˆåº•å¸³å–® / å³æ‰£";
    ccCountdown.textContent = "â€”";
    ccBar.style.width = "0%";
  }

  // æ§åˆ¶è®Šå‹•ï¼šå³æ™‚é‡é‹ªï¼ˆä¸ç­‰ä¸‹ä¸€é¡Œï¼‰
  sizeCtl.addEventListener("input", ()=>{
    if(qIndex>=0 && qIndex < BANK.length){
      stopLoop();
      spawnForQuestion(BANK[qIndex]);
    }
  });
  diffCtl.addEventListener("change", ()=>{
    if(qIndex>=0 && qIndex < BANK.length){
      stopLoop();
      spawnForQuestion(BANK[qIndex]);
    }
  });

  btnStart.addEventListener("click", ()=>{
    if(qIndex >= BANK.length-1 && !running && birds.length===0){
      qIndex = -1;
    }
    nextQuestion();
  });
  btnReset.addEventListener("click", resetAll);

  window.addEventListener("resize", ()=>{
    if(qIndex>=0 && qIndex < BANK.length){
      stopLoop();
      spawnForQuestion(BANK[qIndex]);
    }
  });

  pQ.textContent = `é¡Œè™Ÿï¼š0/${BANK.length}`;
  setHUD();
  resetAll();
})();
</script>
</body>
</html>
